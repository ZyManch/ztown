function BBCode(A){this.construct(A)}BBCode.prototype={VK_TAB:9,VK_ENTER:13,VK_PAGE_UP:33,BRK_OP:"[",BRK_CL:"]",textarea:null,stext:"",quoter:null,collapseAfterInsert:false,replaceOnInsert:false,construct:function(A){this.textarea=A;this.tags=new Object();this.addTag("_quoter",function(){return'[quote="'+B.quoter+'"]'},"[/quote]\n",null,null,function(){B.collapseAfterInsert=true;return B._prepareMultiline(B.quoterText)});var B=this;addEvent(A,"onkeydown",function(C){return B.onKeyPress(C,window.HTMLElement?"down":"press")});addEvent(A,"onkeypress",function(C){return B.onKeyPress(C,"press")})},onclickPoster:function(A){var B=this.getSelection()[0];if(B){this.quoter=A;this.quoterText=B;this.insertTag("_quoter")}else{this.insertAtCursor("[b]"+A+"[/b]\n")}return false},onclickQuoteSel:function(){var A=this.getSelection()[0];if(A){this.insertAtCursor("[quote]"+A+"[/quote]\n")}else{alert("Please select text.")}return false},emoticon:function(A){if(A){this.insertAtCursor(" "+A+" ")}else{return false}return false},refreshSelection:function(A){if(A){this.stext=this.getSelection()[0]}else{this.stext=""}},getSelection:function(){var A=window;var C="",B;if(A.getSelection){C=A.getSelection()}else{if(A.document.getSelection){C=A.document.getSelection()}else{if(A.document.selection&&A.document.selection.createRange){B=A.document.selection.createRange();C=B.text}else{return[null,null]}}}if(C==""){C=this.stext}C=""+C;C=C.replace("/^s+|s+$/g","");return[C,B]},insertAtCursor:function(E){var C=this.textarea;C.focus();if(document.selection&&document.selection.createRange){var D=document.selection.createRange();if(!this.replaceOnInsert){D.collapse()}D.text=E}else{if(C.setSelectionRange){var G=this.replaceOnInsert?C.selectionStart:C.selectionEnd;var B=C.selectionEnd;var A=C.value.substr(0,G);var F=C.value.substr(B);C.value=A+E+F;C.setSelectionRange(G+E.length,G+E.length)}else{C.value+=E}}setTimeout(function(){C.focus()},100)},surround:function(K,O,A){var P=this.textarea;P.focus();if(!A){A=function(R){return R}}var G=this.getSelection();var N=G[0];var L=G[1];if(N==null){return false}var F=N!=null&&N!="";if(L){var F=N!=null&&N!="";var J=K+A(N)+(O?O:"");L.text=J;L.collapse();if(N!=""){var M=0;for(var I=0;I<J.length;I++){if(J.charAt(I)=="\r"){M++}}L.moveStart("character",-O.length-N.length-K.length+M);L.moveEnd("character",-0)}else{L.moveEnd("character",-O.length)}if(!this.collapseAfterInsert){L.select()}}else{if(P.setSelectionRange){var B=P.selectionStart;var H=P.selectionEnd;var E=P.value.substr(0,B);var D=P.value.substr(H);var C=A(P.value.substr(B,H-B));var Q=K+C+O;P.value=E+Q+D;if(C!=""){P.setSelectionRange(B,B+Q.length);F=true}else{P.setSelectionRange(B+K.length,B+K.length);F=false}if(this.collapseAfterInsert){P.setSelectionRange(B+Q.length,B+Q.length)}}else{P.value+=K+N+O}}this.collapseAfterInsert=false;return F},_cancelEvent:function(A){if(A.preventDefault){A.preventDefault()}if(A.stopPropagation){A.stopPropagation()}return A.returnValue=false},onKeyPress:function(F,C){var B=String.fromCharCode(F.keyCode?F.keyCode:F.charCode);for(var G in this.tags){var A=this.tags[G];if(A.ctrlKey&&!F[A.ctrlKey+"Key"]){continue}if(!A.key||B.toUpperCase()!=A.key.toUpperCase()){continue}if(F.type=="keydown"){this.insertTag(G)}return this._cancelEvent(F)}if(C=="press"&&F.keyCode==this.VK_TAB&&!F.shiftKey&&!F.ctrlKey&&!F.altKey){this.surround("\t","");return this._cancelEvent(F)}if(F.keyCode==this.VK_TAB&&!F.shiftKey&&F.ctrlKey&&!F.altKey){this.textarea.form.post.focus();return this._cancelEvent(F)}var D=this.textarea.form;var E=null;if(F.keyCode==this.VK_PAGE_UP&&F.shiftKey&&!F.ctrlKey&&F.altKey){E=D.add_attachment_box}if(F.keyCode==this.VK_ENTER&&!F.shiftKey&&!F.ctrlKey&&F.altKey){E=D.preview}if(F.keyCode==this.VK_ENTER&&!F.shiftKey&&F.ctrlKey&&!F.altKey){E=D.post}if(E){E.click();return this._cancelEvent(F)}return true},addTag:function(B,F,H,G,C,D){if(!C){C="ctrl"}var I=new Object();I.id=B;I.open=F;I.close=H;I.key=G;I.ctrlKey=C;I.multiline=D;I.elt=this.textarea.form[B];this.tags[B]=I;var E=I.elt;if(E){var A=this;if(E.type&&E.type.toUpperCase()=="BUTTON"){addEvent(E,"onclick",function(){A.insertTag(B);return false})}if(E.tagName&&E.tagName.toUpperCase()=="SELECT"){addEvent(E,"onchange",function(){A.insertTag(B);return false})}}else{if(B&&B.indexOf("_")!=0){return alert("addTag('"+B+"'): no such element in the form")}}},insertTag:function(D){var A=this.tags[D];if(!A){return alert("Unknown tag ID: "+D)}var C=A.open;if(typeof (A.open)=="function"){C=A.open(A.elt)}var B=A.close!=null?A.close:"/"+C;if(C.charAt(0)!=this.BRK_OP){C=this.BRK_OP+C+this.BRK_CL}if(B&&B.charAt(0)!=this.BRK_OP){B=this.BRK_OP+B+this.BRK_CL}this.surround(C,B,!A.multiline?null:A.multiline===true?this._prepareMultiline:A.multiline)},_prepareMultiline:function(A){A=A.replace(/\s+$/,"");A=A.replace(/^([ \t]*\r?\n)+/,"");if(A.indexOf("\n")>=0){A="\n"+A+"\n"}return A}};function checkForm(B){var A=false;if(B.message.value.length<2){A="Please enter the message."}if(A){setTimeout(function(){alert(A)},100);return false}return true}function addEvent(C,B,E,A){B=B.replace(/^(on)?/,"on");var F=C[B];var D="__tmp";C[B]=function(H){if(!H){H=window.event}var G;if(!A){C[D]=E;G=C[D](H);C[D]=null;if(G===false){return G}}if(F){C[D]=F;G=C[D](H);C[D]=null}if(A&&G!==false){C[D]=E;G=C[D](H);C[D]=null}return G};return E}if(window.HTMLElement&&window.HTMLElement.prototype.__defineSetter__){HTMLElement.prototype.__defineSetter__("innerText",function(A){this.innerHTML=A.replace(/\&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")});HTMLElement.prototype.__defineGetter__("innerText",function(){var A=this.ownerDocument.createRange();A.selectNodeContents(this);return A.toString()})}function copyText(A){if(!document.body.createTextRange){return false}BodyRange=document.body.createTextRange();if(!BodyRange.moveToElementText){return false}BodyRange.moveToElementText(A);if(!BodyRange.execCommand){return false}BodyRange.execCommand("Copy");return true}function AddSelectedText(A,B){if(document.post.message.caretPos){document.post.message.caretPos.text=A+document.post.message.caretPos.text+B}else{document.post.message.value+=A+B}document.post.message.focus()}function InsertBBCode(A){AddSelectedText("["+A+"]","[/"+A+"]")}function storeCaret(A){if(A.createTextRange){A.caretPos=document.selection.createRange().duplicate()}}var t_table1="ABVGDEZIJKLMNOPRSTUFXHCYWabvgdezijklmnoprstufxhcyw'#";var w_table1="ÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÕÖÛÙàáâãäåçèéêëìíîïðñòóôõõöûùüú";var t_table2="EHSZYOJOZHCHSHYUJUYAJAehszyojozhchshyujuyajaEhSzYoJoZhChShYuJuYaJa";var w_table2="ÝÙ¨¨Æ×ØÞÞßßýù¸¸æ÷øþþÿÿÝÙ¨¨Æ×ØÞÞßß";var tagArray=["code","","img","","quote","(=[\"']?[^"+String.fromCharCode(92,93)+"]+)?","email","(=[\"']?[a-zA-Z0-9_.-]+@?[a-zA-Z0-9_.-]+[\"']?)?","url","(=[\"']?[^ \"'"+String.fromCharCode(92,93)+"]*[\"']?)?"];function translit2win(C){var B=C.length;var A="";for(i=0;i<B;i++){if(C.substr(i).indexOf("^")==0){end_len=C.substr(i+1).indexOf("^")+2;if(end_len>1){A+=C.substr(i,end_len);i+=end_len-1;continue}}if(C.substr(i).indexOf(":")==0){iEnd=C.substr(i+1).indexOf(":")+2;if(iEnd>1&&C.substr(i,iEnd).match("^:[a-zA-Z0-9]+:$")){A+=C.substr(i,iEnd);i+=iEnd-1;continue}}rExp=new RegExp("^((http|https|news|ftp|ed2k):\\/\\/[\\/a-zA-Z0-9%_?.:;&#|()+=@-]+)","i");if(newArr=C.substr(i).match(rExp)){A+=newArr[1];i+=newArr[1].length-1;continue}rExp=new RegExp("^(\\[\\/?(b|i|u|s|font(=[a-z0-9]+)?|size(=[0-9]+)?|color(=#?[a-z0-9]+)?)\\])","i");if(newArr=C.substr(i).match(rExp)){A+=newArr[1];i+=newArr[1].length-1;continue}bSkip=false;for(j=0;j<tagArray.length;j+=2){rExp=new RegExp("^(\\["+tagArray[j]+tagArray[j+1]+"\\])","i");if(newArr=C.substr(i).match(rExp)){rExp=new RegExp("\\[\\/"+tagArray[j]+"\\]","i");if(iEnd=C.substr(i+newArr[1].length+2).search(rExp)){end_len=iEnd+newArr[1].length+tagArray[j].length+4;A+=C.substr(i,end_len);i+=end_len-1;bSkip=true}}if(bSkip){break}}if(bSkip){continue}is2char=false;if(i<B-1){for(j=0;j<w_table2.length;j++){if(C.substr(i,2)==t_table2.substr(j*2,2)){A+=w_table2.substr(j,1);i++;is2char=true;break}}}if(!is2char){var E=C.substr(i,1);var D=t_table1.indexOf(E);if(D<0){A+=E}else{A+=w_table1.substr(D,1)}}}return A}function transliterate(B,A){if(A){A.disabled=true}setTimeout(function(){if(!bbcode.surround("","",translit2win)){B.value=translit2win(B.value)}if(A){A.disabled=false}},1)};